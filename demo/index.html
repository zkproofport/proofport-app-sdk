<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ZKProofport SDK Demo</title>
  <link rel="icon" type="image/png" href="/favicon.png">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <!-- OpenGraph -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="ZKProofport SDK Demo">
  <meta property="og:description" content="Interactive demo of the ZKProofport SDK for zero-knowledge proof requests and verification.">
  <meta property="og:site_name" content="ZKProofport">
  <meta property="og:url" content="__DEMO_BASE_URL__/index">
  <meta property="og:image" content="__DEMO_BASE_URL__/og-image.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:image:type" content="image/png">
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="ZKProofport SDK Demo">
  <meta name="twitter:description" content="Interactive demo of the ZKProofport SDK for zero-knowledge proof requests and verification.">
  <meta name="twitter:image" content="__DEMO_BASE_URL__/og-image.png">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f5f5f5;
      padding: 20px;
      line-height: 1.6;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    h1 {
      color: #111;
      margin-bottom: 10px;
      font-size: 2em;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }

    .card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 30px;
      margin-bottom: 20px;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      border-bottom: 2px solid #eee;
    }

    .tab {
      padding: 12px 24px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      color: #666;
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s;
    }

    .tab:hover {
      color: #2563eb;
    }

    .tab.active {
      color: #2563eb;
      border-bottom-color: #2563eb;
      font-weight: 600;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 500;
    }

    input, select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.2s;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #2563eb;
    }

    .help-text {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 30px;
    }

    button {
      flex: 1;
      padding: 14px 24px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    button.primary {
      background: #2563eb;
      color: white;
    }

    button.primary:hover {
      background: #1d4ed8;
    }

    button.secondary {
      background: #f3f4f6;
      color: #374151;
    }

    button.secondary:hover {
      background: #e5e7eb;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .result {
      margin-top: 30px;
      padding: 20px;
      background: #f8fafc;
      border-radius: 6px;
      border: 1px solid #e2e8f0;
    }

    .result h3 {
      margin-bottom: 15px;
      color: #1e293b;
    }

    .result-item {
      margin-bottom: 12px;
    }

    .result-label {
      font-weight: 600;
      color: #475569;
      display: inline-block;
      min-width: 120px;
    }

    .result-value {
      color: #1e293b;
      word-break: break-all;
      font-family: monospace;
      font-size: 13px;
    }

    #qrcode {
      text-align: center;
      margin-top: 20px;
    }

    #qrcode img {
      max-width: 300px;
      width: 100%;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 10px;
      background: white;
    }

    .toggle-group {
      display: flex;
      gap: 10px;
      margin-top: 8px;
    }

    .toggle-option {
      flex: 1;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 6px;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s;
    }

    .toggle-option.active {
      border-color: #2563eb;
      background: #eff6ff;
      color: #2563eb;
      font-weight: 600;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ZKProofport SDK Demo</h1>
    <p class="subtitle">Generate ZK proof requests using the ZKProofport SDK</p>

    <div class="card">
      <div class="card-header" style="margin-bottom: 16px;">
        <div class="card-title" style="font-size: 16px;">API Key Authentication (Required)</div>
        <span id="auth-badge" class="badge" style="display: none;">Authenticated</span>
      </div>
      <p style="color: #666; font-size: 13px; margin-bottom: 16px;">
        Enter your API credentials to authenticate. Get these from the <a href="__DASHBOARD_URL__/dashboard/dapps" target="_blank" style="color: #2563eb;">Dashboard</a>.
      </p>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
        <div class="form-group" style="margin-bottom: 0;">
          <label>Client ID</label>
          <input type="text" id="auth-client-id" placeholder="Your client_id from dashboard">
        </div>
        <div class="form-group" style="margin-bottom: 0;">
          <label>API Key</label>
          <input type="password" id="auth-api-key" placeholder="Your api_key (shown once)">
        </div>
      </div>
      <div style="margin-bottom: 24px; display: flex; gap: 12px; align-items: center;">
        <button type="button" id="btn-authenticate" class="secondary">Authenticate</button>
        <button type="button" id="btn-clear-auth" class="secondary" style="display: none;">Clear Auth</button>
        <span id="auth-status" style="font-size: 13px; color: #666;"></span>
      </div>
    </div>

    <div class="card">
      <div class="tabs">
        <button class="tab active" data-tab="kyc">Coinbase KYC</button>
        <button class="tab" data-tab="country">Coinbase Country</button>
      </div>

      <div id="kyc-tab" class="tab-content active">
        <form id="kyc-form">
          <div class="form-group">
            <label for="kyc-dapp-name">Dapp Name (optional)</label>
            <input
              type="text"
              id="kyc-dapp-name"
              placeholder="My Dapp"
            >
          </div>

          <div class="form-group">
            <label for="kyc-message">Message (optional)</label>
            <input
              type="text"
              id="kyc-message"
              placeholder="Please verify your Coinbase KYC"
            >
          </div>

          <div class="button-group">
            <button type="submit" class="primary" disabled id="btn-kyc-generate">Generate QR Code</button>
            <button type="button" id="kyc-open" class="secondary" disabled>Open in ZKProofport</button>
          </div>
        </form>
      </div>

      <div id="country-tab" class="tab-content">
        <form id="country-form">
          <div class="form-group">
            <label for="country-list">Country List *</label>
            <input
              type="text"
              id="country-list"
              placeholder="US,KR,JP"
              value="US,KR,JP"
              required
            >
            <div class="help-text">Comma-separated ISO 3166-1 alpha-2 country codes</div>
          </div>

          <div class="form-group">
            <label>List Type</label>
            <div class="toggle-group">
              <div class="toggle-option active" data-value="include">
                Include List (user IN list)
              </div>
              <div class="toggle-option" data-value="exclude">
                Exclude List (user NOT IN list)
              </div>
            </div>
            <div class="help-text">Whether to check if user is in or not in the country list</div>
          </div>

          <div class="form-group">
            <label for="country-dapp-name">Dapp Name (optional)</label>
            <input
              type="text"
              id="country-dapp-name"
              placeholder="My Dapp"
            >
          </div>

          <div class="form-group">
            <label for="country-message">Message (optional)</label>
            <input
              type="text"
              id="country-message"
              placeholder="Please verify your country"
            >
          </div>

          <div class="button-group">
            <button type="submit" class="primary" disabled id="btn-country-generate">Generate QR Code</button>
            <button type="button" id="country-open" class="secondary" disabled>Open in ZKProofport</button>
          </div>
        </form>
      </div>

      <div id="result" class="result hidden">
        <h3>Generated Proof Request</h3>
        <div class="result-item">
          <span class="result-label">Request ID:</span>
          <span class="result-value" id="result-request-id"></span>
        </div>
        <div class="result-item">
          <span class="result-label">Circuit:</span>
          <span class="result-value" id="result-circuit"></span>
        </div>
        <div class="result-item">
          <span class="result-label">Deep Link:</span>
          <span class="result-value" id="result-deeplink"></span>
        </div>
        <div id="qrcode"></div>
        <div id="proof-status" class="result-item" style="margin-top: 20px; padding: 16px; background: #f8fafc; border-radius: 6px;">
          <span style="font-weight: 600;">Status:</span>
          <span id="status-text" style="color: #f59e0b;">Waiting for proof...</span>
        </div>
        <div id="proof-result-data" class="hidden" style="margin-top: 20px; padding: 16px; background: #ecfdf5; border: 1px solid #10b981; border-radius: 6px;">
          <h4 style="margin-bottom: 12px; color: #059669;">Proof Received</h4>
          <div class="result-item">
            <span class="result-label">Nullifier:</span>
            <span class="result-value" id="result-nullifier"></span>
          </div>
          <div class="result-item">
            <span class="result-label">Public Inputs:</span>
            <span class="result-value" id="result-public-inputs"></span>
          </div>
          <div class="result-item">
            <span class="result-label">Proof (hex):</span>
            <span class="result-value" id="result-proof" style="word-break: break-all; font-size: 11px;"></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="importmap">
    { "imports": { "socket.io-client": "https://cdn.jsdelivr.net/npm/socket.io-client@4/+esm", "ethers": "https://cdn.jsdelivr.net/npm/ethers@6/+esm" } }
  </script>
  <script type="module">
    import { ProofportSDK } from '../dist/index.mjs';

    const baseUrl = window.location.origin;

    // Detect SDK environment from hostname
    function detectSDKEnv() {
      const host = window.location.hostname;
      if (host === 'localhost' || host === '127.0.0.1' || /^(10\.|192\.168\.|172\.(1[6-9]|2\d|3[01])\.)/.test(host)) return 'local';
      if (host.startsWith('stg-') || host.includes('staging')) return 'staging';
      return 'production';
    }
    const sdkEnv = detectSDKEnv();
    const localRelayUrl = `${window.location.protocol}//${window.location.hostname}:4001`;
    // In local mode, derive relay URL from current hostname to work over LAN
    const sdk = sdkEnv === 'local'
      ? new ProofportSDK({ relayUrl: localRelayUrl })
      : ProofportSDK.create(sdkEnv);

    let currentRelayRequest = null;
    let isIncludedCountry = true;
    let authToken = null;

    // Authentication
    document.getElementById('btn-authenticate').addEventListener('click', async () => {
      const clientId = document.getElementById('auth-client-id').value.trim();
      const apiKey = document.getElementById('auth-api-key').value.trim();

      if (!clientId || !apiKey) {
        document.getElementById('auth-status').textContent = 'Both fields required';
        document.getElementById('auth-status').style.color = '#ef4444';
        return;
      }

      try {
        document.getElementById('btn-authenticate').disabled = true;
        document.getElementById('auth-status').textContent = 'Authenticating...';
        document.getElementById('auth-status').style.color = '#f59e0b';

        authToken = await sdk.login({ clientId, apiKey });

        document.getElementById('auth-status').textContent = 'Authenticated';
        document.getElementById('auth-status').style.color = '#22c55e';
        document.getElementById('auth-badge').style.display = '';
        document.getElementById('auth-badge').textContent = 'Authenticated';
        document.getElementById('auth-badge').className = 'badge';
        document.getElementById('auth-badge').style.background = 'rgba(34, 197, 94, 0.2)';
        document.getElementById('auth-badge').style.color = '#22c55e';
        document.getElementById('btn-clear-auth').style.display = '';

        // Enable proof buttons
        document.getElementById('btn-kyc-generate').disabled = false;
        document.getElementById('kyc-open').disabled = false;
        document.getElementById('btn-country-generate').disabled = false;
        document.getElementById('country-open').disabled = false;

        console.log('Authenticated:', authToken);
      } catch (err) {
        document.getElementById('auth-status').textContent = 'Auth failed: ' + err.message;
        document.getElementById('auth-status').style.color = '#ef4444';
        console.error('Authentication failed:', err);
      } finally {
        document.getElementById('btn-authenticate').disabled = false;
      }
    });

    document.getElementById('btn-clear-auth').addEventListener('click', () => {
      authToken = null;
      document.getElementById('auth-client-id').value = '';
      document.getElementById('auth-api-key').value = '';
      document.getElementById('auth-status').textContent = '';
      document.getElementById('auth-badge').style.display = 'none';
      document.getElementById('btn-clear-auth').style.display = 'none';

      // Disable proof buttons
      document.getElementById('btn-kyc-generate').disabled = true;
      document.getElementById('kyc-open').disabled = true;
      document.getElementById('btn-country-generate').disabled = true;
      document.getElementById('country-open').disabled = true;
    });

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.dataset.tab;

        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

        tab.classList.add('active');
        document.getElementById(`${tabName}-tab`).classList.add('active');

        document.getElementById('result').classList.add('hidden');
      });
    });

    // Country list type toggle
    document.querySelectorAll('.toggle-option').forEach(option => {
      option.addEventListener('click', () => {
        document.querySelectorAll('.toggle-option').forEach(o => o.classList.remove('active'));
        option.classList.add('active');
        isIncludedCountry = option.dataset.value === 'include';
      });
    });

    // KYC Form
    document.getElementById('kyc-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!authToken) {
        alert('Please authenticate first');
        return;
      }

      try {
        const dappName = document.getElementById('kyc-dapp-name').value;
        const message = document.getElementById('kyc-message').value;

        const options = {};
        if (dappName) options.dappName = dappName;
        if (message) options.message = message;

        currentRelayRequest = await sdk.createRelayRequest(
          'coinbase_attestation',
          { scope: 'zkproofport:demo' },
          options
        );

        await displayResult(currentRelayRequest);
        await waitForProof(currentRelayRequest.requestId);
      } catch (err) {
        alert('Request failed: ' + err.message);
        console.error('KYC request failed:', err);
      }
    });

    document.getElementById('kyc-open').addEventListener('click', async () => {
      if (!authToken) {
        alert('Please authenticate first');
        return;
      }

      try {
        if (!currentRelayRequest) {
          const dappName = document.getElementById('kyc-dapp-name').value;
          const message = document.getElementById('kyc-message').value;

          const options = {};
          if (dappName) options.dappName = dappName;
          if (message) options.message = message;

          currentRelayRequest = await sdk.createRelayRequest(
            'coinbase_attestation',
            { scope: 'zkproofport:demo' },
            options
          );
        }
        window.location.href = currentRelayRequest.deepLink;
      } catch (err) {
        alert('Request failed: ' + err.message);
        console.error('KYC request failed:', err);
      }
    });

    // Country Form
    document.getElementById('country-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!authToken) {
        alert('Please authenticate first');
        return;
      }

      try {
        const countryListStr = document.getElementById('country-list').value;
        const dappName = document.getElementById('country-dapp-name').value;
        const message = document.getElementById('country-message').value;

        const countryList = countryListStr.split(',').map(c => c.trim().toUpperCase()).filter(c => c);

        if (countryList.length === 0) {
          alert('Country list is required');
          return;
        }

        const inputs = {
          countryList,
          isIncluded: isIncludedCountry,
          scope: 'zkproofport:demo'
        };

        const options = {};
        if (dappName) options.dappName = dappName;
        if (message) options.message = message;

        currentRelayRequest = await sdk.createRelayRequest(
          'coinbase_country_attestation',
          inputs,
          options
        );

        await displayResult(currentRelayRequest);
        await waitForProof(currentRelayRequest.requestId);
      } catch (err) {
        alert('Request failed: ' + err.message);
        console.error('Country request failed:', err);
      }
    });

    document.getElementById('country-open').addEventListener('click', async () => {
      if (!authToken) {
        alert('Please authenticate first');
        return;
      }

      try {
        if (!currentRelayRequest) {
          const countryListStr = document.getElementById('country-list').value;
          const dappName = document.getElementById('country-dapp-name').value;
          const message = document.getElementById('country-message').value;

          const countryList = countryListStr.split(',').map(c => c.trim().toUpperCase()).filter(c => c);

          if (countryList.length === 0) {
            alert('Country list is required');
            return;
          }

          const inputs = {
            countryList,
            isIncluded: isIncludedCountry,
            scope: 'zkproofport:demo'
          };

          const options = {};
          if (dappName) options.dappName = dappName;
          if (message) options.message = message;

          currentRelayRequest = await sdk.createRelayRequest(
            'coinbase_country_attestation',
            inputs,
            options
          );
        }
        window.location.href = currentRelayRequest.deepLink;
      } catch (err) {
        alert('Request failed: ' + err.message);
        console.error('Country request failed:', err);
      }
    });

    async function displayResult(relayRequest) {
      document.getElementById('result-request-id').textContent = relayRequest.requestId;
      document.getElementById('result-circuit').textContent = relayRequest.circuit || 'N/A';
      document.getElementById('result-deeplink').textContent = relayRequest.deepLink;

      const qrDataUrl = await sdk.generateQRCode(relayRequest.deepLink, { width: 300 });
      document.getElementById('qrcode').innerHTML = `<img src="${qrDataUrl}" alt="QR Code" />`;

      document.getElementById('result').classList.remove('hidden');
      document.getElementById('proof-status').classList.remove('hidden');
      document.getElementById('status-text').textContent = 'Waiting for proof...';
      document.getElementById('status-text').style.color = '#f59e0b';
      document.getElementById('proof-result-data').classList.add('hidden');
    }

    async function waitForProof(requestId) {
      try {
        console.log('[waitForProof] Starting to wait for:', requestId);

        const result = await sdk.waitForProof(requestId, {
          onStatusChange: (statusUpdate) => {
            console.log('[waitForProof] Status update:', statusUpdate);
            const statusText = document.getElementById('status-text');
            if (statusUpdate.status === 'pending') {
              statusText.textContent = 'Pending...';
              statusText.style.color = '#f59e0b';
            } else if (statusUpdate.status === 'processing') {
              statusText.textContent = 'Processing...';
              statusText.style.color = '#3b82f6';
            }
          },
          timeoutMs: 300000 // 5 minutes
        });

        console.log('[waitForProof] Proof received:', result);

        // Update status
        const statusText = document.getElementById('status-text');
        statusText.textContent = 'Proof completed!';
        statusText.style.color = '#22c55e';

        // Display proof data
        const nullifier = result.nullifier || (result.publicInputs && result.publicInputs[0]) || 'N/A';
        document.getElementById('result-nullifier').textContent = nullifier;
        document.getElementById('result-public-inputs').textContent = result.publicInputs ? result.publicInputs.length : 0;
        document.getElementById('result-proof').textContent = result.proof || 'N/A';

        document.getElementById('proof-result-data').classList.remove('hidden');

      } catch (err) {
        console.error('[waitForProof] Error:', err);
        const statusText = document.getElementById('status-text');
        statusText.textContent = 'Failed: ' + err.message;
        statusText.style.color = '#ef4444';
      }
    }
  </script>
</body>
</html>
